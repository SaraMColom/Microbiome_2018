---
title: "Simplified Analysis"
author: "Sara Colom"
date: "2/8/2020"
output: 
  github_document:
    toc: false
    df_print: kable
---

# Objectives

Evaluate microbial community diversity at the Genus level and its relationship with plant root architecture and plant fitness across and between stressful enviornments.

We address the following specific research aims:

  - **Aim 1:** Do measures of microbial communities vary with root phenotypes? (e.g., root architecture, morphology, and size)
  - **Aim 2:** Within a non stressful environment or control treatment (i.e., no competition), does plant fitness vary by measures of microbial community after adjusting for root architecture? Is there evidence that plant fitness varies according to microbial community by root architecture interaction?
  - **Aim 3:** Question 2 extended--do these relationships change in stressful environment? In other words, does belowground plant-plant competition alter relationships with plant fitness and microbial communities?

## Sample sizes

### Table sample number by species and treatment


| Species          | Treatment       | N      |
|--------------    |-------------    |----    |
| I. purpurea      | Alone           | 27     |
| I. purpurea      | Competition     | 73     |
| I. hederacea     | Competition     | 73     |


### Table number of maternal line per species

| Species          | Number of ML     |
|--------------    |--------------    |
| I. purpurea      |      10          |
| I. hederacea     |       5          |



# Load Libraries

```{r load_libs, include=T, warning=F, comment=F, message=F}
library(tidyverse)
library(phyloseq)
library(vegan)
library(broom)
library(MASS)
library(ggpubr)
library(grid)
library(stringr)
library(broom)
library(car)

source("miSeq.R")
source("functions.R")
```



# Read in Data

```{r Import Data,warning=F,comment=F,message=F}
physeq1 <- readRDS("../DataSets/physeq_clean")
physeq.scale <- readRDS("../DataSets/physeq_scaled")
alpha <- readRDS("../DataSets/alpha")

RootData <- read.csv("../DataSets/RootTraits_PCs.csv")
LeafData <- read.csv("../DataSets/SizeFitData.csv")
Fitness = read.csv("../DataSets/FitPA4.csv")
```

# Sample sizes

#### Samples by block within IP
```{r}
alpha %>% 
  filter(Species == "Ip") %>% 
  count(Block)
```

#### Samples of treatment within IP


```{r}
alpha %>% 
  filter(Species == "Ip") %>% 
  count(TRT)
```


## Alpha Diversity

```{r, message = F, warning = F, comment = F}
# Visualize data distribution w Violin plots within I.purpurea

p <- ggplot(alpha %>% filter(Species == "Ip"), aes(x = TRT, y = rich)) +
  geom_violin(trim = FALSE, aes(fill = TRT), alpha = 0.3) + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, aes(color = TRT, fill = TRT)) +
  theme_classic() +
  scale_color_brewer(palette = "Paired") +
  scale_fill_brewer(palette = "Paired") +
  ggtitle("Species Richness")


q <- ggplot(alpha %>% filter(Species == "Ip"), aes(x = TRT, y = InvSimp)) +
  geom_violin(trim = FALSE, aes(fill = TRT), alpha = 0.3) + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, aes(color = TRT, fill = TRT)) +
  theme_classic() +
  scale_color_brewer(palette = "Paired") +
  scale_fill_brewer(palette = "Paired") +
  ggtitle("Species Inverse Simpson") +
  ylab("")


t <- ggplot(alpha %>% filter(Species == "Ip"), aes(x = TRT, y = sim)) +
  geom_violin(trim = FALSE, aes(fill= TRT), alpha = 0.3) + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, aes(color = TRT, fill = TRT)) +
  theme_classic() +
  scale_color_brewer(palette = "Paired") +
  scale_fill_brewer(palette = "Paired") +
  ggtitle("Simpson") +
  ylab("")

v <- ggplot(alpha %>% filter(Species == "Ip"), aes(x = TRT, y = even)) +
  geom_violin(trim = FALSE, aes(fill = TRT), alpha = 0.3) + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, aes(color = TRT, fill = TRT)) +
  theme_classic() +
  scale_color_brewer(palette = "Paired") +
  scale_fill_brewer(palette = "Paired") +
  ggtitle("Evenness") +
  ylab("")

ggarrange(p, q, t, v, common.legend = T, ncol = 2, nrow = 2)
```

# Community Composition

## Beta Diversity

```{r}
physeq.bray <- phyloseq::distance(physeq = physeq.scale, method = "bray")

# # # # # # # # # # # # # # # # # # # # # 
# Subsample for within I. purpurea only
# # # # # # # # # # # # # # # # # # # # # 

physeq.Purp <- subset_samples(physeq.scale, Species == "Ip")
sampledf.Purp<- data.frame(sample_data(physeq.Purp))

# Calculate bray curtis for I.purpurea samples only
physeq.Purp.bray <- phyloseq::distance(physeq = physeq.Purp, method = "bray")

```


```{r PCoA Treatment and Species comparisoin Bray Curtis Estimate, warning = F, comment = F, message = F, fig.height = 12, fig.width = 16}

# Beta diversity pcoa Bray-Curtis DNA only 
physeq.pcoa <-
  ordinate(
    physeq = physeq.scale,
    method = "PCoA",
    distance = "bray"
  )

physeq.pcoa.vectors <- data.frame(physeq.pcoa$vectors[, 1:4])

physeq.pcoa.vectors$Duplicates <- row.names(physeq.pcoa.vectors)

SampData <- data.frame(sample_data(physeq1))

colnames(SampData)[1] <- "Duplicates"

SampData <- subset(SampData, SampData$TRT == "Inter"|SampData$TRT == "Alone")

physeq.pcoa.df <- droplevels(merge(physeq.pcoa.vectors, SampData, by="Duplicates"))
```

# Testing linear relationships between root architecture & microbial diversity

## Prep root data

```{r Preliminary exam on root linear model}
RootAlphaObs <- merge(alpha, RootData[c("Sample_ID", "PC1", "PC2", "PC3", "PC4")])
```

### Evaluate relationship between alpha diversity and root traits

```{r Preliminary exam on roots within species}
#summary(glht(SimpInvPC1, mcp(rank="Tukey")))

#################################################################
##################### SUBSET for I.purpurea #####################
#################################################################

RootAlphaPurp <- droplevels(RootAlphaObs %>% filter(Species == "Ip"))
RootAlphaPurp$Comp <- sub(".*\\-", "", RootAlphaPurp$Combos)


### Linear regressions

SimpPC1 <- lm(sim ~ PC1 + Block + TRT, RootAlphaPurp) 
summary(SimpPC1)

SimpInvPC1 <- lm(InvSimp ~ PC1  + TRT + Block, RootAlphaPurp) 
summary(SimpInvPC1)

RichPC1 <- lm(rich ~ PC1 + Block + TRT, RootAlphaPurp) 
summary(RichPC1)

EvenPC1 <- lm(even ~ PC1 + Block + TRT , RootAlphaPurp) 
summary(EvenPC1)

SimpPC2 <- lm(sim ~ PC2 + Block + TRT, RootAlphaPurp) 
summary(SimpPC2)

SimpInvPC2 <- lm(InvSimp ~ PC2  + TRT + Block, RootAlphaPurp) 
summary(SimpInvPC2)

RichPC2 <- lm(rich ~ PC2 + Block + TRT, RootAlphaPurp) 
summary(RichPC2)

EvenPC2 <- lm(even ~ PC2 + Block + TRT , RootAlphaPurp) 
summary(EvenPC2) 

SimpPC3 <- lm(sim ~ PC3 + Block + TRT, RootAlphaPurp) 
summary(SimpPC3)

SimpInvPC3 <- lm(InvSimp ~ PC3  + TRT + Block, RootAlphaPurp) 
summary(SimpInvPC3)

RichPC3 <- lm(rich ~ PC3 + Block + TRT, RootAlphaPurp) 
summary(RichPC3)

EvenPC3 <- lm(even ~ PC3 + Block + TRT , RootAlphaPurp) 
summary(EvenPC3)

SimpPC4 <- lm(sim ~ PC4 + Block + TRT, RootAlphaPurp %>% filter(PC4 > -2.5)) 
summary(SimpPC4)

# Repeat & remove outlier
SimpPC4_out <- lm(sim ~ PC4 + Block + TRT, RootAlphaPurp %>% filter(sim > 0.94)) 
summary(SimpPC4_out)

SimpInvPC4 <- lm(InvSimp ~ PC4  + TRT + Block, RootAlphaPurp) 
summary(SimpInvPC4)

RichPC4 <- lm(rich ~ PC4 + Block + TRT, RootAlphaPurp) 
summary(RichPC4)

EvenPC4 <- lm(even ~ PC4 + Block + TRT , RootAlphaPurp) 
summary(EvenPC4)
```


## Make tables of results ABOVE with only root term in model and combine

PC1
```{r}
SimpInvPC1_res <- SimpInvPC1 %>% 
  tidy() %>% 
  filter(term == "PC1") %>% 
  mutate(`Microbial community metric` = "Inverse Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root topology" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root topology`)


SimpPC1_res <- SimpPC1 %>% 
  tidy() %>% 
  filter(term == "PC1") %>% 
  mutate(`Microbial community metric` = "Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`)  %>% 
  mutate(b = b*1000,
         SE = SE*1000) %>% 
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root topology" = paste(b, "e^3", " +/- ", SE, "e^3", sep = "")) %>% 
  dplyr::select(`Microbial community metric`, `Root topology`)

RichPC1_res <- RichPC1 %>% 
  tidy() %>% 
  filter(term == "PC1") %>% 
  mutate(`Microbial community metric` = "Sp. richness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root topology" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root topology`)  

EvenPC1_res <- EvenPC1 %>% 
  tidy() %>% 
  filter(term == "PC1") %>% 
  mutate(`Microbial community metric` = "Sp. evenness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`)  %>% 
  mutate(b = b*1000000,
         SE = SE*1000000) %>% 
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root topology" = paste(b, "e^6", " +/- ", SE, "e^6", sep = "")) %>% 
  dplyr::select(`Microbial community metric`, `Root topology`) 

microbe_root_lm_res_pc1 <- SimpInvPC1_res %>% 
  bind_rows(
  RichPC1_res
  ) %>% 
  bind_rows(
    EvenPC1_res
  ) %>% 
  bind_rows(SimpPC1_res) 
  
```


PC2
```{r}
SimpInvPC2_res <- SimpInvPC2 %>% 
  tidy() %>% 
  filter(term == "PC2") %>% 
  mutate(`Microbial community metric` = "Inverse Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root architecture" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root architecture`)

SimpPC2_res <- SimpPC2 %>% 
  tidy() %>% 
  filter(term == "PC2") %>% 
  mutate(`Microbial community metric` = "Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
    mutate(b = b*10000,
           SE = SE*10000) %>% 
    mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
    mutate("Root architecture" = paste(b, "e^4", " +/- ", SE, "e^4", sep = "")) %>% 
  dplyr::select(`Microbial community metric`, `Root architecture`)  

RichPC2_res <- RichPC2 %>% 
  tidy() %>% 
  filter(term == "PC2") %>% 
  mutate(`Microbial community metric` = "Sp. richness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>%
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root architecture" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root architecture`)  

EvenPC2_res <- EvenPC2 %>% 
  tidy() %>% 
  filter(term == "PC2") %>% 
  mutate(`Microbial community metric` = "Sp. evenness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
    mutate(b = b*100000,
           SE = SE*100000) %>% 
    mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
    mutate("Root architecture" = paste(b, "e^5", " +/- ", SE, "e^5", sep = "")) %>% 
  dplyr::select(`Microbial community metric`, `Root architecture`)  

microbe_root_lm_res_pc2 <- SimpInvPC2_res %>% 
  bind_rows(
  RichPC2_res
  ) %>% 
  bind_rows(
    EvenPC2_res
  ) %>% 
  bind_rows(SimpPC2_res) 
  
```


PC3

```{r}
SimpInvPC3_res <- SimpInvPC3 %>% 
  tidy() %>% 
  filter(term == "PC3") %>% 
  mutate(`Microbial community metric` = "Inverse Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>%
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root size" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root size`)    

SimpPC3_res <- SimpPC3 %>% 
  tidy() %>% 
  filter(term == "PC3") %>% 
  mutate(`Microbial community metric` = "Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`)%>% 
    mutate(b = b*10000,
           SE = SE*10000) %>% 
    mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
    mutate("Root size" = paste(b, "e^4", " +/- ", SE, "e^4", sep = "")) %>% 
  dplyr::select(`Microbial community metric`, `Root size`)    

RichPC3_res <- RichPC3 %>% 
  tidy() %>% 
  filter(term == "PC3") %>% 
  mutate(`Microbial community metric` = "Sp. richness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>%
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root size" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root size`)    

EvenPC3_res <- EvenPC3 %>% 
  tidy() %>% 
  filter(term == "PC3") %>% 
  mutate(`Microbial community metric` = "Sp. evenness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
    mutate(b = b*100000,
           SE = SE*100000) %>% 
    mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
    mutate("Root size" = paste(b, "e^5", " +/- ", SE, "e^5", sep = ""))%>% 
  dplyr::select(`Microbial community metric`, `Root size`)    

microbe_root_lm_res_pc3 <- SimpInvPC3_res %>% 
  bind_rows(
  RichPC3_res
  ) %>% 
  bind_rows(
    EvenPC3_res
  ) %>% 
  bind_rows(SimpPC3_res)

```


PC4
```{r}
SimpInvPC4_res2 <- SimpInvPC4 %>% 
  tidy() %>% 
  filter(term == "PC4") %>% 
  mutate(`Microbial community metric` = "Inverse Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>%
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root morphology" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root morphology`)    

SimpPC4_res2 <- SimpPC4 %>% 
  tidy() %>% 
  filter(term == "PC4") %>% 
  mutate(`Microbial community metric` = "Simpson Diversity") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
    mutate(b = b*10000,
           SE = SE*10000) %>% 
    mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
    mutate("Root morphology" = paste(b, "e^4", " +/- ", SE, "e^4", sep = "")) %>% 
  dplyr::select(`Microbial community metric`, `Root morphology`) 

RichPC4_res2 <- RichPC4 %>% 
  tidy() %>% 
  filter(term == "PC4") %>% 
  mutate(`Microbial community metric` = "Sp. richness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>%
  mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
  mutate("Root morphology" = paste(b, "+/-", SE, sep = " ")) %>% 
  dplyr::select(`Microbial community metric`, `Root morphology`) 

EvenPC4_res2 <- EvenPC4 %>% 
  tidy() %>% 
  filter(term == "PC4") %>% 
  mutate(`Microbial community metric` = "Sp. evenness") %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic, `p_value` = `p.value`) %>% 
  relocate(`Microbial community metric`) %>% 
    mutate(b = b*100000,
           SE = SE*100000) %>% 
    mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
    mutate("Root morphology" = paste(b, "e^5", " +/- ", SE, "e^5", sep = ""))%>% 
  dplyr::select(`Microbial community metric`, `Root morphology`) 

microbe_root_lm_res_pc4 <- SimpInvPC4_res2 %>% 
  bind_rows(
  RichPC4_res2
  ) %>% 
  bind_rows(
    EvenPC4_res2
  ) %>% 
  bind_rows(SimpPC4_res2)
  
```

# Table 1.


Table 1 Results of separate linear regression between different metrics (ɑ-Diversity Metric) of the rhizosphere microbiome (Inverse Simpson, Simpson, Richness and Evenness) and four root traits (Root topology, Root architecture, Root size and Root morphology) examined in I. purpurea. ɑ-Diversity metrics were treated as response variables for each root trait, and Block and competition treatment (Treatment) were included in the final modelǂ as fixed main effects. Linear regression coefficient slopes (𝛣) are reported with ± 1 standard error. P < 0.05 *; P <0.01 **; P <0.001***; P =0.09 ^ 


```{r}
table_1 <- microbe_root_lm_res_pc1 %>% 
  left_join(microbe_root_lm_res_pc2, by = "Microbial community metric") %>% 
  left_join(microbe_root_lm_res_pc3, by = "Microbial community metric") %>% 
  left_join(microbe_root_lm_res_pc4, by = "Microbial community metric")

table_1
```



## Plotting significant linear associations 

Species richness and evenness vs Root architecture (PC2)
```{r n}
# Richness and root architecture
P2.rich <- ggplot() +
  geom_point(data = RootAlphaPurp, aes(PC2, rich), alpha = 0.5, size = 4, color = "#C4961A") +
  geom_smooth(data = RootAlphaPurp, method = "lm", aes(PC2, rich), fullrange = TRUE, color = "#4E84C4", size = 1.2, fill = "#DCDCDC") +
  theme_classic() +
  ylab("Richness") +
  xlab("") +
  theme(axis.text = element_text(color = "black", size = 12)) +
  theme(axis.title = element_text(color = "black", size = 18)) +
  theme(legend.text = element_text(size = 12)) +
  theme(legend.position = "top") +
  guides(colour = guide_legend(override.aes = list(size = 3)))

# Evenness and root architecture
P2.even <- ggplot() +
  geom_point(data = RootAlphaPurp, aes(PC2, even), alpha = 0.5, size = 4, color = "#C4961A") +
  geom_smooth(data = RootAlphaPurp, method = "lm", aes(PC2, even), fullrange = TRUE, color = "#4E84C4", size = 1.2, fill = "#DCDCDC") +
  theme_classic() +
  ylab("Evenness") +
  xlab("") +
  theme(axis.text = element_text(color = "black", size = 12)) +
  theme(axis.title = element_text(color = "black", size = 18)) +
  theme(legend.text = element_text(size = 12)) +
  theme(legend.position = "top") +
  guides(colour = guide_legend(override.aes = list(size = 3)))

```

```{r}
# Richness and root architecture
P4.sim <- ggplot() +
  geom_point(data = RootAlphaPurp, aes(PC4, sim), alpha = 0.5, size = 3, color = "#C4961A") +
  geom_smooth(data = RootAlphaPurp, method = "lm", aes(PC4, sim), fullrange = TRUE, color = "#4E84C4", size = 1.2, fill = "#DCDCDC") +
  theme_classic() +
  ylab("simpson Diversity") +
  xlab("") +
  theme(axis.text = element_text(color = "black", size = 12)) +
  theme(axis.title = element_text(color = "black", size = 18)) +
  theme(legend.text = element_text(size = 12)) +
  theme(legend.position = "top") +
  guides(colour = guide_legend(override.aes = list(size = 3)))

```


# Figure 1

```{r, fig.height = 8, fig.width = 16}
#ggarrange(P2.rich,P2.even,P4.Sim,P4.simIn,nrow=2,ncol=2)
AB <- ggarrange(P2.rich, P2.even, labels = "AUTO", hjust = -7, vjust = 1.5,font.label = list(size = 14))


# Common x title
x.grob1 <- textGrob("Root architecture (PC2)", 
                   gp = gpar(col="black", fontsize = 25), rot = 0)

gridExtra::grid.arrange(gridExtra::arrangeGrob(AB, bottom = x.grob1, padding = unit(0.05,units = 'in'), nrow=1))
```


```{r Read in fitness data}
# Calculate relative fitness
# First calculate mean seed number by species and treatment---note* we only have seed output of I. purpurea

Fitness <- Fitness %>% 
  group_by(Species, Trt) %>% 
  mutate(mean_seend_num = mean(SeedNumber, na.rm = T)) %>% 
  mutate(rel_fit = SeedNumber/mean_seend_num) %>% 
  ungroup()

Ipurp.Fit <- Fitness %>%
  filter(Species == "Ip")

Ipurp.Alpha <- alpha %>%
  filter(Species == "Ip")

ggplot(Ipurp.Fit, aes(Trt, rel_fit, fill=Block)) +
  geom_boxplot() +
  scale_fill_brewer("Paired") +
  theme_classic() +
  ylab("Relative Fitness") +
  ggtitle("Relative Fitness by Treatment and Block")

# Average fitness by block, maternal line and treatment--we use NON standardized fitness (ie size effects not removed)
FitAveraged <- Ipurp.Fit %>% 
  group_by(ML, Trt, Block) %>% 
  mutate(rel_fit_mean = mean(rel_fit, na.rm = T)) %>% 
  ungroup()
```


```{r, fig.height = 12, fig.width = 16}
####  ####  ####  ####  ####  ####   ####
#  Examine selection on microbiome first
####  ####  ####  ####  ####  ####   ####
FitAveraged$TRT <- FitAveraged$Trt
FitAveraged$Combos <- as.character(FitAveraged$Combos)
FitAveraged[which(FitAveraged$TRT == "Alone"),]$Combos <- "none"
FitAveraged$Combos <- as.factor(FitAveraged$Combos)

BrayFit <- merge(physeq.pcoa.df, FitAveraged)

FitAlpha <- merge(FitAveraged, alpha)
dim(FitAlpha)

ggplot(FitAlpha, aes(TRT, rel_fit)) +
  geom_boxplot() +
  scale_fill_brewer("Paired") +
  theme_classic() +
  ylab("Relative Fitness") +
  ggtitle("Relative Fitness by Treatment and Block") +
  facet_grid(~Block)


# Combine with root data

RootAveraged <- aggregate(list(RootData[c("PC1", "PC2", "PC3", "PC4")]), by=list(RootData$Trt, RootData$ML), FUN = mean) 

colnames(RootAveraged) <- c("Trt", "ML", "PC1", "PC2", "PC3", "PC4")
head(RootAveraged)

RootFitAlpha <- merge(FitAlpha, RootAveraged)
head(RootFitAlpha)

# CombinE root,fitness/bray estimates
RootFitBray <- merge(BrayFit, RootAveraged)


# Plot boxplots of averaged root traits
PC2_Box <- ggplot(RootAveraged, aes(x = "", y = PC2)) +
  geom_boxplot() +
  #geom_jitter() +
  xlab("Root Architecture") +
  theme_classic() +
  Tx+ 
  coord_flip()

# Plot boxplots of averaged root traits
PC1_Box=ggplot(RootAveraged, aes(x = "", y = PC1)) +
  geom_boxplot() +
  #geom_jitter() +
  xlab("Root Topology") +
  theme_classic() +
  Tx+ 
  coord_flip()

# Plot boxplots of averaged root traits
PC4_Box=ggplot(RootAveraged, aes(x = "", y = PC4)) +
  geom_boxplot() +
  #geom_jitter() +
  xlab("Root Morphology") +
  theme_classic() +
  Tx+ 
  coord_flip()
```




## 7/29/2022


- Evaluate linear relationship of _I.purpurea_ fitness and microbial richness, inverse Simpson, and evenness within the control (_alone_) treatment for each metric separately.

- Evaluate if relationship above is impacted by treatment (evaluate linear model on full data and add treatment by microbial diversity metric/interaction)

- Assess how _I.purpurea_ fitness in control varies with the three main microbial metrics while controlling for root architecture.


Prior to running models below, I will visualize the relationships between microbial community metrics and plant fitness and color by treatment.

```{r}
# Scale the microbial variables
RootFitAlpha$richScaled <-scale(RootFitAlpha$rich)
RootFitAlpha$SimScaled <-scale(RootFitAlpha$sim)
RootFitAlpha$InvSimScaled <-scale(RootFitAlpha$InvSimp)
RootFitAlpha$EvenScaled <-scale(RootFitAlpha$even)

RootFitAlpha %>% 
  dplyr::select(TRT, matches("Scaled"), rel_fit, Block) %>% 
  pivot_longer(cols = richScaled:EvenScaled, names_to = "vars", values_to = "value") %>% 
  ggplot() +
  geom_point(aes(value, rel_fit, color = TRT)) +
  geom_smooth(aes(value, rel_fit, color = TRT), method='lm', se = F) +
  facet_wrap(~vars) +
  theme_classic()
```


## Question 2

```{r}

cntrl_Sim <- lm(rel_fit ~ SimScaled*PC2 + Block, RootFitAlpha %>% 
                   filter(TRT == "Alone"))

cntrl_sim_res <- cntrl_Sim %>% 
                        tidy() %>% 
                        rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()


cntrl_invSim <- lm(rel_fit ~ InvSimScaled*PC2 + Block, RootFitAlpha %>% 
                   filter(TRT == "Alone"))

cntrl_invsim_res <- cntrl_invSim %>% 
                        tidy() %>% 
                        rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()

cntrl_invsim_res

cntrl_rich <- lm(rel_fit ~ richScaled*PC2 + Block, RootFitAlpha %>% 
                   filter(TRT == "Alone"))

cntrl_rich_res <- cntrl_rich %>% 
                        tidy() %>% 
                        rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()
cntrl_rich_res

cntrl_even <- lm(rel_fit ~ EvenScaled*PC2 + Block, RootFitAlpha %>% 
                   filter(TRT == "Alone"))

cntrl_even_res <- cntrl_even %>% 
                        tidy() %>% 
                        rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()
cntrl_even_res
```

## Question 3

Examining if fitness varies by microbial diversity by treatment interaction.

```{r}
ancova_sim <- lm(rel_fit ~ SimScaled*TRT + Block*SimScaled + SimScaled*PC2 , RootFitAlpha)

ancova_sim <- anova(ancova_sim) %>% 
  tidy() %>% 
  tidy_more()


ancova_invsim <- lm(rel_fit ~ InvSimScaled*TRT + Block*InvSimScaled + InvSimScaled*PC2 , RootFitAlpha)

ancova_invsim <- anova(ancova_invsim) %>% 
  tidy() %>% 
  tidy_more()

ancova_rich <- lm(rel_fit ~ richScaled*TRT + Block*richScaled + richScaled*PC2, RootFitAlpha)

ancova_rich <- anova(ancova_rich) %>% 
  tidy( ) %>% 
  tidy_more()

ancova_even <- lm(rel_fit ~ EvenScaled*TRT + Block*EvenScaled + EvenScaled*PC2, RootFitAlpha)

ancova_even <- anova(ancova_even) %>% 
  tidy() %>% 
  tidy_more()

ancova_invsim
ancova_rich
ancova_even
```


### Revaluation controling for _ALL_ root traits

Add root traits as co-variates in the model and perform across treatments. Perfrom t-tests.

```{r}
all_invSim2 <- lm(rel_fit ~ InvSimScaled + InvSimScaled*PC1 + InvSimScaled*PC2 + InvSimScaled*PC3 + InvSimScaled*PC4 + Block, RootFitAlpha)

all_invSim_res2 <- all_invSim2 %>% 
                        tidy() %>% 
                        rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()

all_invSim_res2

all_rich2 <- lm(rel_fit ~ richScaled + richScaled*PC1 + richScaled*PC2 + richScaled*PC3 + richScaled*PC4 + Block, RootFitAlpha)

all_rich_res2 <- all_rich2 %>% 
                        tidy() %>% 
                        rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()
all_rich_res2

all_even2 <- lm(rel_fit ~ EvenScaled  + EvenScaled*PC1 + EvenScaled*PC2 + EvenScaled*PC3 + EvenScaled*PC4 + Block, RootFitAlpha)

all_even_res2 <- all_even2 %>% 
                        tidy() %>% 
                        rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()
all_even_res2
```


Run F-tests on the models above.
```{r}
library(car)

ancova_invsim_all_roots <- Anova(all_invSim2, type = "III") %>% 
  tidy() %>% 
  tidy_more()

ancova_rich_all_roots <- Anova(all_rich2 , type = "III") %>% 
  tidy( ) %>% 
  tidy_more()


ancova_even_all_roots <- Anova(all_even2, type = "III") %>% 
  tidy() %>% 
  tidy_more()

ancova_invsim_all_roots
ancova_rich_all_roots
ancova_even_all_roots
```


Investigating quadratic effects (i.e. nonlinear relationships.)

```{r}
RootFitAlpha <- RootFitAlpha %>% 
  mutate(InvSimScaled2 = InvSimScaled*InvSimScaled,
         richScaled2 = richScaled*richScaled,
         EvenScaled2 = EvenScaled*EvenScaled)

all_rich2 <- lm(rel_fit ~ InvSimScaled + InvSimScaled2 + InvSimScaled*TRT + Block + InvSimScaled*PC1 + InvSimScaled*PC2 + InvSimScaled*PC3 + InvSimScaled*PC4, RootFitAlpha)

InvSim2_res <- all_rich2 %>%
  tidy() %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()


all_rich2 <- lm(rel_fit ~ richScaled + richScaled2 +richScaled*TRT + Block + richScaled*PC1 + richScaled*PC2 + richScaled*PC3 + richScaled*PC4, RootFitAlpha)

Rich2_res <- all_rich2 %>%
  tidy() %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()

all_even2 <- lm(rel_fit ~ EvenScaled + EvenScaled2 + EvenScaled*TRT + EvenScaled*PC1 + EvenScaled*PC2 + EvenScaled*PC3 + EvenScaled*PC4 + Block, RootFitAlpha)

Even2_res <- all_even2 %>%
  tidy() %>% 
  rename(b = estimate, SE = `std.error`, `t-statistic` = statistic) %>% 
                        mutate(across(where(is.numeric), function(x) round(x, 3))) %>% 
                        rename(`p_value` = `p.value`) %>% 
                        tidy_p()

InvSim2_res
Even2_res
Rich2_res
```

#### MANTEL test (supplimentary)
```{r}  
#  Here we use the Family mean values of root traits---this would indicate evidence for 'phenotypic selection' 

  # Load matrix Bray distances of OTU abundance
  OTU_table = t(otu_table(physeq1)) # Write out OTU table
  

  # Pull out Root traits of interest and save these to the Sampled data frame
  SampledFit = merge(FitAveraged, sampledf.Purp, by = c("TRT", "ML", "Block"))


# Pull out Root traits of interest and save these to the Sampled data frame
SampledRoots = merge(RootAlphaObs, sampledf.Purp)
SampledRootsIp = subset(SampledRoots, Species == "Ip")

OTU_table = OTU_table[row.names(OTU_table) %in% SampledRootsIp$Sample_ID,]


    OTU = OTU_table
    Roots = SampledRootsIp

  # Calculate root architecture distances with euclidean distance 

    PC2 = SampledRootsIp$PC2 # isolate PC2, i.e. root architecture
    PC2.dist = dist(PC2)

  # Calculate Bray distance matrix for OTU table

    Bray = vegdist(OTU, method = "bray")


    
# OTU Bray vs Root architecture

    OTU_pc2 = mantel(Bray, PC2.dist, method = "spearman", permutations = 9999, na.rm = TRUE)

    # Marginally significant--very low r value
    # Mantel statistic r: 0.06836  
    # Significance: 0.07
    
# Repeat for root topology, size and morphology

  PC1 = SampledRootsIp$PC1 # isolate 
  PC1.dist = dist(PC1)
  PC3 = SampledRootsIp$PC3 # isolate 
  PC3.dist=dist(PC3)
  PC4 = SampledRootsIp$PC1 # isolate 
  PC4.dist = dist(PC4)

# Examine overall distances in root system; i.e. use all PCs in distance calculation

    PCall = SampledRootsIp[grep("PC",names(SampledRootsIp))]
    PC.dist = dist(PCall)

    OTU_pc = mantel(Bray, PC.dist, method = "spearman", permutations = 9999, na.rm = TRUE)

###             examine mantel test using observed values of roots ###

OTU_pc1 = mantel(Bray, PC1.dist, method = "spearman", permutations = 9999, na.rm = TRUE)
# OTU_pc2 = mantel(Bray,PC2.dist, method = "spearman", permutations = 9999, na.rm = TRUE)
OTU_pc3 = mantel(Bray, PC3.dist, method = "spearman", permutations = 9999, na.rm = TRUE)
OTU_pc4 = mantel(Bray, PC4.dist, method = "spearman", permutations = 9999, na.rm = TRUE)
```

PC1 Mantel

```{r}
OTU_pc1
```

PC2 Mantel

```{r}
OTU_pc2
```


PC3 Mantel

```{r}
OTU_pc3
```


PC4 Mantel

```{r}
OTU_pc4
```


# Export models

```{r}
tables <- list(
  # Tables Question 2
    table_1 = table_1,
    cntrl_even_res = cntrl_even_res, 
    cntrl_rich_res = cntrl_rich_res,
    cntrl_invsim_res = cntrl_invsim_res,
    cntrl_sim_res = cntrl_sim_res,
  # Tables Question 3
    ancova_even = ancova_even, 
    ancova_invsim = ancova_invsim,
    ancova_sim = ancova_sim,
    ancova_rich = ancova_rich)

writexl::write_xlsx(tables, "manuscript_tables.xlsx")
```

